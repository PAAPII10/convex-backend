name: Deploy Convex Self-Hosted Backend

on:
  push:
    branches: [ 'main' ]
    paths:
      - 'convex-backend/**'
      - '.github/workflows/deploy.yml'

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  PRIVATE_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
  USERNAME: ${{ secrets.EC2_USERNAME }}
  HOST_DNS: ${{ secrets.HOST_DNS }}
  AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
  CONVEX_ENV: ${{ secrets.CONVEX_ENV }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_DEFAULT_REGION }}

    - name: SSH into EC2 instance and deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ env.HOST_DNS }}
        username: ${{ env.USERNAME }}
        key: ${{ env.PRIVATE_SSH_KEY }}
        script: |
          set -e
          
          echo "üöÄ Starting Convex Backend Deployment..."
          
          # Navigate to convex-backend directory (create if doesn't exist)
          mkdir -p ~/convex-backend
          cd ~/convex-backend
          
          # Check if docker-compose.prod.yml exists, if not download official version
          if [ ! -f docker-compose.prod.yml ]; then
            echo "üì¶ Docker Compose file not found. Setting up files..."
            if [ -d ".git" ]; then
              echo "‚úÖ Git repository found, files should be present"
            else
              echo "üì• Downloading official docker-compose.yml and adapting for production..."
              curl -s https://raw.githubusercontent.com/get-convex/convex-backend/main/self-hosted/docker/docker-compose.yml -o docker-compose.prod.yml
              # Modify for production: bind to localhost only
              sed -i 's/- "${PORT:-3210}:3210"/- "127.0.0.1:3210:3210"/' docker-compose.prod.yml
              sed -i 's/- "${SITE_PROXY_PORT:-3211}:3211"/- "127.0.0.1:3211:3211"/' docker-compose.prod.yml
              sed -i 's/- "${DASHBOARD_PORT:-6791}:6791"/- "127.0.0.1:6791:6791"/' docker-compose.prod.yml
              echo "‚úÖ Created docker-compose.prod.yml from official source"
            fi
          fi
          
          # Create or update .env file from GitHub secret
          echo "üìù Configuring environment variables..."
          cat << 'ENV_EOF' > .env
          ${{ env.CONVEX_ENV }}
          ENV_EOF
          
          # Ensure Docker is running
          sudo systemctl start docker || true
          sudo chmod 666 /var/run/docker.sock || true
          
          # Detect docker-compose command
          echo "üîç Detecting Docker Compose command..."
          DOCKER_COMPOSE_CMD=""
          if command -v docker-compose &> /dev/null; then
            DOCKER_COMPOSE_CMD="docker-compose"
            echo "‚úÖ Using docker-compose (standalone)"
          elif docker compose version &> /dev/null; then
            DOCKER_COMPOSE_CMD="docker compose"
            echo "‚úÖ Using docker compose (plugin)"
          else
            echo "‚ùå Docker Compose not found. Installing..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            DOCKER_COMPOSE_CMD="docker-compose"
            echo "‚úÖ Installed docker-compose"
          fi
          
          echo "üì• Pulling latest Docker images..."
          $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml pull
          
          echo "üîÑ Stopping existing services..."
          $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml down || true
          
          echo "‚úÖ Starting services with latest images..."
          $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml up -d
          
          echo "‚è≥ Waiting for services to be healthy..."
          sleep 15
          
          echo "üè• Checking backend health..."
          if curl -f http://localhost:3210/version > /dev/null 2>&1; then
            echo "‚úÖ Backend is healthy!"
          else
            echo "‚ö†Ô∏è  Backend health check failed. Check logs with: $DOCKER_COMPOSE_CMD logs"
            exit 1
          fi
          
          echo "üìä Service Status:"
          docker ps --filter "name=convex" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo ""
          echo "üìã Docker Compose Version:"
          $DOCKER_COMPOSE_CMD --version || $DOCKER_COMPOSE_CMD version
          
          echo ""
          echo "‚úÖ Deployment complete!"
